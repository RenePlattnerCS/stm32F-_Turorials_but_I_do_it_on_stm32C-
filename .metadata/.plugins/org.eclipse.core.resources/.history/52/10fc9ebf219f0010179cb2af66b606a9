#include "exti.h"

#define GPIOCEN		(1U<<2)
#define SYSCFGEN	(1U<<0)


void pc13_exti_init(void)
{
    RCC->IOPENR |= (1U << 2);             // Enable GPIOC
    GPIOC->MODER &= ~(3U << (13 * 2));    // PC13 input
    GPIOC->PUPDR &= ~(3U << (13 * 2));    // Pull-up
    GPIOC->PUPDR |=  (1U << (13 * 2));

    RCC->APBENR2 |= (1U << 0);  // Enable SYSCFG clock

    // Map EXTI13 to Port C
    EXTI->EXTICR[3] &= ~(0xFU << 4);
    EXTI->EXTICR[3] |=  (0x2U << 4);

    // Clear pending flag
    EXTI->RPR1 = LINE13;

    // Falling edge trigger
    EXTI->FTSR1 |= LINE13;
    EXTI->RTSR1 &= ~LINE13;

    // Unmask line
    EXTI->IMR1 |= LINE13;

    // Enable NVIC
    NVIC_EnableIRQ(EXTI4_15_IRQn);

}
